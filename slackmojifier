#!/usr/bin/env ruby
# frozen_string_literal: true

require 'docopt'

begin
  OPTS = Docopt.docopt <<~DOCOPT
    slackmojifier

    Import ALL THE EMOJI from Slackmoji into Slack!

    Usage:
        slackmojifier <slack-team> <slack-cookie>

    Options:
        -h --help     Show this screen.
  DOCOPT
rescue Docopt::Exit => e
  puts e.message
  exit(1)
end

require 'down'
require 'nokogiri'
require 'open-uri'
require 'pry'

BASE_URL = 'https://slackmojis.com'
EMOJI_URL = "#{BASE_URL}/emojis/popular"
SLACK_BASE_URL = 'https://%s.slack.com/customize/emoji'

def slackmojifier(slack_url, slack_cookie)
  Nokogiri::HTML.parse(OpenURI.open_uri(EMOJI_URL)).css('a.downloader').each do |d|
    copy_emoji("#{BASE_URL}#{d['href']}", slack_url, slack_cookie)
    break
  end
end

def copy_emoji(url, slack_url, headers)
  tempfile = download(url)
  begin
    # emoji_name = os.path.basename(url).split("-")[0]
    # _upload(emoji_name, file_name, slack_url, headers)
  ensure
    tempfile.close
    tempfile.unlink
  end
end

def download(url)
  puts "downloading: #{url}"
  Down.download(url)
end


# def _upload(name, file_name, slack_url, headers):
#     print("uploading: {}".format(name))
#     data = {
#         'add': 1,
#         'crumb': _get_crumb(slack_url, headers),
#         'name': name,
#         'mode': 'data',
#     }
#     with open(file_name, 'rb') as fp:
#         files = {'img': fp}
#         response = requests.post(slack_url,
#                                  headers=headers,
#                                  data=data,
#                                  files=files,
#                                  allow_redirects=False)
#     response.raise_for_status()
#
#
# def _get_crumb(slack_url, headers):
#     response = requests.get(slack_url, headers=headers)
#     response.raise_for_status()
#     soup = BeautifulSoup(response.text, "html.parser")
#     return soup.find("input", attrs={"name": "crumb"})["value"]

slackmojifier(SLACK_BASE_URL % OPTS['<slack-team>'], OPTS['<slack-cookie>'])
