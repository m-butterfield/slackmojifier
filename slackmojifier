#!/usr/bin/env ruby
# frozen_string_literal: true

require 'docopt'

begin
  OPTS = Docopt.docopt <<~DOCOPT
    slackmojifier

    Import custom emoji from Slackmoji into Slack!

    Usage:
        slackmojifier <slack-team> <slack-cookie>

    Options:
        -h --help     Show this screen.
  DOCOPT
rescue Docopt::Exit => e
  puts e.message
  exit(1)
end

require 'down'
require 'http'
require 'nokogiri'
require 'open-uri'

require 'pry' # remove this

SLACKMOJI_BASE_URL = 'https://slackmojis.com'
SLACKMOJI_LISTING_URL = "#{SLACKMOJI_BASE_URL}/emojis/popular"
SLACK_BASE_URL = 'https://%s.slack.com/customize/emoji'
SLACK_API_URL = 'https://slack.com/api/admin.emoji.add'

def slackmojifier(slack_url, slack_headers)
  Nokogiri::HTML.parse(OpenURI.open_uri(SLACKMOJI_LISTING_URL)).css('a.downloader').each do |d|
    url = "#{SLACKMOJI_BASE_URL}#{d['href']}"
    name = d.text.strip.gsub(/\A\:|\:\Z/, '')
    tempfile = Down.download(url)
    begin
      upload(name, tempfile.read, slack_url, slack_headers)
      break # remove this...
    ensure
      tempfile.close
      tempfile.unlink
    end
    break
  end
end

def upload(emoji_name, emoji_data, slack_url, slack_headers)
  puts "Uploading: #{emoji_name}"
  crumb = get_crumb(slack_url, slack_headers)
  # resp = HTTP.post(SLACK_API_URL, form: { token: auth_token, mode: 'data', name: name, image: HTTP::FormData::File.new(tempfile.path)})
  #   data = {
#     add: 1,
#     crumb: _get_crumb(slack_url, cookie),
#     name: emoji_name,
#     mode: 'data',
#   }
#   https://slack.com/api/admin.emoji.add
  # with open(file_name, 'rb') as fp:
  #     files = {'img': fp}
  #     response = requests.post(slack_url,
  #                              headers=headers,
  #                              data=data,
  #                              files=files,
  #                              allow_redirects=False)
  # response.raise_for_status()
end

def get_crumb(slack_url, slack_headers)
  result = Nokogiri::HTML.parse(OpenURI.open_uri(slack_url, slack_headers))
  input = result.css('input[name="crumb"]')
  binding.pry
  # response = HTTP.get(slack_url, headers=headers)
  # response.raise_for_status()
  # soup = BeautifulSoup(response.text, "html.parser")
  # soup.find("input", attrs={"name": "crumb"})["value"]
end

slackmojifier(SLACK_BASE_URL % OPTS['<slack-team>'], { "cookie" => OPTS['<slack-cookie>'] })
